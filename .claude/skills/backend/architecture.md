# アーキテクチャ詳細

## クリーンアーキテクチャの層構造

Datti APIバックエンドはクリーンアーキテクチャに基づいて関心の分離を明確にしています。

### ドメイン層 (`internal/domain/`)

**責務**: コアのビジネスエンティティとビジネスルール

- ビジネスエンティティ: User、Credit、Lending、Payer、Debtor、Amount
- バリデーションロジック
- リポジトリインターフェース（実装は含まない）
- 他の層に依存しない純粋なビジネスロジック

**主要なドメインコンセプト**:

#### User
- UUID主キーを使用
- ユーザープロフィール情報

#### PaymentEvent / Lending / Credit
- ULID形式のTEXT主キー
- 1人の支払者が複数の債務者の費用を立て替えた支払いイベント
- Lending: 支払者視点（誰に貸したか）
- Credit: 債務者視点（誰から借りたか）

#### Payer
- 金額を支払ったユーザー
- イベント全体の総額を保持

#### Debtor
- お金を借りているユーザー
- 個別の金額を持つ

#### Amount
- 金額のバリデーション付きバリューオブジェクト
- すべて円（整数扱い）
- 負の値を許可しない

**不変性の原則**:
- すべてのドメインエンティティはコンストラクタ関数で生成
- 作成後は変更不可（イミュータブル）
- バリデーションはコンストラクタで実行

### ユースケース層 (`internal/usecase/`)

**責務**: アプリケーションのビジネスロジックとオーケストレーション

- 複数のリポジトリを組み合わせたビジネスフロー
- トランザクション管理
- ドメインエンティティの操作
- OpenTelemetryトレース対応

**依存関係**:
- ドメイン層のインターフェースに依存
- プレゼンテーション層から呼び出される

### ゲートウェイ層 (`internal/gateway/`)

**責務**: 外部システムとの連携

#### `postgres/` サブディレクトリ
- SQLCで生成されたデータベースクエリ
- 生成されたモデル型
- **手動編集禁止**: `sql/query.sql` を編集後 `task gen-sqlc` で再生成

#### `repository/` サブディレクトリ
- ドメインインターフェースの実装
- ドメインモデル ↔ データベースモデルの変換
- OpenTelemetryトレース対応
- エラーハンドリング

**重要**: リポジトリはドメイン層で定義されたインターフェースを実装します。

### プレゼンテーション層 (`internal/presentation/api/`)

**責務**: HTTPリクエスト/レスポンス処理

- HTTPハンドラー
- OpenAPIで生成された型（`types.gen.go`）
- サーバースタブ（`server.gen.go`）
- リクエストバリデーション
- レスポンス整形
- 認証情報取得（現在はダミー実装）

**コード生成**:
- `task gen-types`: OpenAPI → Go型定義
- `task gen-server`: OpenAPI → サーバーインターフェース

## データベーススキーマ

### users テーブル
- UUID主キー
- ユーザープロフィール情報

### events テーブル
- ULID形式のTEXT主キー
- 支払いイベント情報
- 支払者情報

### payments テーブル
- イベントと債務者ユーザー間の多対多関係
- 個別の債務金額を保持

## 依存関係の方向

```
プレゼンテーション層
        ↓
   ユースケース層
        ↓
    ドメイン層
        ↑
   ゲートウェイ層
```

- 内側の層は外側の層を知らない
- 外側の層は内側の層に依存
- ドメイン層が中心（依存なし）
- ゲートウェイ層はドメイン層のインターフェースを実装

## 主要な依存関係

- **Echo v4**: HTTPフレームワーク
- **pgx/v5**: PostgreSQLドライバー
- **SQLC**: タイプセーフなSQLコード生成
- **oapi-codegen**: OpenAPI型・サーバー生成
- **gomock**: モック生成
- **OpenTelemetry**: トレース・メトリクス
- **ULID**: 辞書順でソート可能なユニークID
- **UUID**: ユーザー識別用

## トレースとメトリクス

既存のOpenTelemetry設定に従い、必要なスパン情報を補完する。

- **`APP_ENV=production`**: Google Cloud Trace エクスポーター
- **その他**: OTLP HTTP エクスポーター（ローカル: `http://localhost:4318`）

各層でのトレース実装:
- リポジトリ層: データベースクエリのトレース
- ユースケース層: ビジネスロジックのトレース
- プレゼンテーション層: HTTPリクエストのトレース
