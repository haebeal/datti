# Agent Handbook

エージェントが作業を始める前に必ずこのファイルを確認し、最新の情報源として維持してください。README は人間向けの全体説明、本書はエージェントが即戦力として動くためのルールと手順をまとめたものです。

## 1. 作業開始前の確認
- **ブランチ確認**: 作業対象ブランチ（例: `feature/...`）を事前に共有し、ユーザーの合意を取ってから着手する。
- **プラン共有と承認**: これから実施するタスクを細分化して説明し、OK をもらってから実行する。途中でステップを追加する場合も再度確認する。
- **進捗の扱い**: 標準フローのどこにいるかをこまめに共有し、次へ進む前に合意を得る。
- **未確定事項の管理**: 仕様が曖昧な点は TODO やメモとして残し、このファイルに反映する（解消したら速やかに削除）。

## 2. 作業の流れ（段階ごとのタスク例）
1. **契約の定義**  
   - ユースケースの要件を確認し、必要なエンドポイント・スキーマを検討する。  
   - TypeSpec 編集前に変更内容とレビュー観点をユーザーと共有する。
2. **TypeSpec 実装と検証**  
   - `docs/openapi` で TypeSpec を実装し、`npm run compile` で生成物を確認する。  
   - 生成結果（OpenAPI YAML/JSON）を確認し、想定どおりかレビューする。
   - TypeSpec 更新後は必ず `npm run compile` → `task gen-types` → `task gen-server` を順に実行し、生成コードを最新化する。
3. **プレゼンテーション層の生成**  
   - `apps/backend` で `task gen-types` → `task gen-server` を実行する。  
   - 生成された `types.gen.go` / `server.gen.go` を確認し、エンドポイント追加を検証する。
4. **ドメインモデリング**  
   - 新しい値オブジェクト／エンティティ／ドメインサービスを整理する。  
   - 未確定事項は TODO として残し、テスト観点も併記する。
   - 例: `internal/domain/credit.go` のように、API で必要な概念をドメイン層に立てる。
5. **永続化モデルの準備**  
   - 必要に応じて `apps/backend/sql/schema.sql` / `query.sql` を編集し、データモデルを整える。  
   - `task gen-sqlc` を実行して生成コードを更新し、`internal/gateway/postgres` の差分を確認する。
6. **リポジトリ層の整備**  
   - ドメインで定義したインターフェースを `internal/domain` に追加・更新する。  
   - `internal/gateway/repository` に実装を追加し、トレース・エラーハンドリングを揃える。  
   - モックが必要なら `task gen-mocks` を実行して最新化する。
7. **ユースケース入出力定義**  
   - ユースケースの Input/Output DTO やインターフェースはプレゼンテーション層（例: `internal/presentation/api/handler`）で定義し、ユースケース実装から参照する。  
   - 出力は可能な限りドメインエンティティ（例: `*domain.Credit`）を保持し、プレゼンテーション層で整形する。
   - バリデーションルールや想定エラーを洗い出し、テスト観点をメモする。
8. **ユースケース実装**  
   - リポジトリを組み合わせてビジネスロジックを実装し、トレース・エラー処理を整備する。  
   - 例外ケースの挙動を明確にし、戻り値やエラー内容を統一する。
9. **ユースケーステスト**  
   - `internal/usecase/test` にモックを生成（必要なら `task gen-mocks` を実行）し、テーブルドリブンテストを追加する。  
   - 想定したバリデーション・エラーケースを網羅し、テスト結果を共有する。
10. **ハンドラー実装**  
    - 生成済みインターフェースに沿ってハンドラーを実装し、リクエスト検証・認証情報取得・レスポンス整形を行う。  
    - エラー時のレスポンスフォーマットをユースケースと揃える。
11. **ハンドラーテスト**  
    - ハンドラー用モックが必要なら更新し、`internal/presentation/api/handler/test` にテーブルドリブンテストを配置する。  
    - レスポンスコード・ボディを確認し、境界ケースのテストも追加する。
12. **DI・総合検証**  
    - `cmd/main.go` などの DI を更新し、ルーティングを登録する。  
    - `task test`（= `go test -race ./...`）を実行し、必要に応じて E2E/手動検証を補う。  
    - 実行できない場合は理由と代替手段を記録する。

## 3. 実務ルール（必ず順守）
- **契約を起点にする**: TypeSpec を変更したら必ず `docs/openapi` で `npm run compile` を実行し、生成物がクリーンであることを確認してから次の層へ進む。
- **生成コードの管理**  
  - OpenAPI 変更後は `task gen-types` → `task gen-server`。  
  - SQL を編集したら `task gen-sqlc`。モックが必要になったら `task gen-mocks`。  
  - 生成物は元データと同じコミットにまとめる。
- **実装は層ごとに進める**: ドメイン → リポジトリ → ユースケース → プレゼンテーションの順を守る。仕様が未確定な箇所は TODO を残し、このハンドブックにも記載する。
- **テストと検証**  
  - 追加機能には単体テストを用意し、テーブルドリブンを基本とする。  
  - 最終的に `task test`（= `go test -race ./...`）を通す。実行できない場合は理由と代替検証を記録する。
- **コミットとログ**  
  - コミットメッセージは日本語・命令形で一意に作成し、生成物と元ファイルは同一コミットに含める。  
  - コミット前にこのハンドブックの該当セクション（特に「作業開始前の確認」や TODO）を最新化し、差分を残す。

## 4. 環境とフォーマットの注意
- **Go 1.24**: `gofmt` / `goimports` を必ず適用（タブインデント）。
- **生成ファイル** (`*.gen.go`, `*.gen.ts`): 手動編集は禁止。生成元を更新しコマンドを再実行する。
- **認証・認可**: 現状はダミー実装（`middleware.AuthMiddleware` が `uid` を注入）。将来的に OAuth を導入予定だが、今フェーズでは考慮不要。
- **通貨**: すべて円（整数扱い）。多通貨対応はスコープ外。
- **環境変数**: `apps/backend/.env` を参照し、機微情報は追加しない。
- **メトリクス／トレース**: 既存の OpenTelemetry 設定に従い、必要なスパン情報を補完する。
  - `APP_ENV=production` のときは Google Cloud Trace エクスポーター、その他は OTLP HTTP エクスポーターを使用する。ローカルでトレースを送信したい場合は Jaeger などを `http://localhost:4318` で起動しておく。

## 5. 主要コマンド
- `npm run compile`（`docs/openapi`）: TypeSpec から OpenAPI を生成。
- `task gen-types` / `task gen-server`（`apps/backend`）: oapi-codegen の出力更新。
- `task gen-sqlc`（`apps/backend`）: SQLC のコード生成。
- `task gen-mocks`（`apps/backend`）: mockgen によるモック生成。
- `task test`（`apps/backend`）: `go test -race ./...` の実行。
- `air`（`apps/backend`）: ホットリロード開発サーバーの起動。

## 6. ディレクトリと役割
- `apps/backend/internal/domain`: ドメインモデル・値オブジェクト。
- `apps/backend/internal/gateway`: リポジトリ実装（SQLC 生成物を利用）。
- `apps/backend/internal/usecase`: アプリケーションユースケース。
- `apps/backend/internal/presentation/api`: oapi-codegen 生成物とハンドラー。
- `apps/backend/sql`: Atlas スキーマ、SQLC クエリ、初期データ。
- `docs/openapi`: TypeSpec ソースと生成物。
- `infra`: Terraform などのインフラ定義（現フェーズでは変更予定なし）。

## 7. ドキュメントの保守
- 新しい作業を始めるときや完了したときは、本書の該当セクションに必要な情報を追記・更新する。
- TODO や未確定事項を残した場合は、解消後に必ず削除する。
- 方針変更が大きい場合は README も更新し、内容を同期させる。

このドキュメントは常に最新状態を保ち、次に入るエージェントが迷わず作業できることを最優先にしてください。
